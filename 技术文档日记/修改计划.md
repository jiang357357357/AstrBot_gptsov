# AstrBot 添加新TTS提供商修改计划

## 🎯 目标
添加新的TTS提供商，让QQ机器人可以使用该厂商发送语音消息

## 📋 基于现有分析

### 现有TTS系统架构
- **TTS提供商**: 继承 `TTSProvider` 基类，实现 `get_audio()` 方法
- **注册机制**: 使用 `@register_provider_adapter` 装饰器注册
- **配置管理**: 在 `default.py` 中定义默认配置
- **管道集成**: 在 `ResultDecorateStage` 中自动调用TTS
- **平台适配**: QQ平台自动处理音频格式转换和发送

### 现有TTS提供商示例
- `ProviderGSVTTS`: GPT-SoVITS本地部署
- `ProviderEdgeTTS`: Microsoft Edge TTS
- `ProviderOpenAITTSAPI`: OpenAI TTS API
- `ProviderDashscopeTTSAPI`: 阿里云通义千问TTS

## 🔧 修改计划

### 第一阶段：创建新TTS提供商类

#### 1.1 创建提供商源文件
**文件位置**: `astrbot/core/provider/sources/your_tts_source.py`

**实现要求**:
```python
@register_provider_adapter(
    provider_type_name="your_tts_type",
    desc="Your TTS Provider Description",
    provider_type=ProviderType.TEXT_TO_SPEECH,
)
class ProviderYourTTS(TTSProvider):
    def __init__(self, provider_config: dict, provider_settings: dict):
        super().__init__(provider_config, provider_settings)
        # 初始化配置参数
        self.api_key = provider_config.get("api_key", "")
        self.api_base = provider_config.get("api_base", "")
        self.voice = provider_config.get("voice", "default")
        self.timeout = provider_config.get("timeout", 30)
        
    async def get_audio(self, text: str) -> str:
        """实现TTS核心方法"""
        # 1. 调用TTS API
        # 2. 保存音频文件到临时目录
        # 3. 返回音频文件路径
        pass
```

#### 1.2 关键实现要点
- **音频格式**: 必须返回WAV格式文件路径
- **临时文件**: 使用 `get_astrbot_data_path()/temp/` 目录
- **错误处理**: 完善的异常处理和日志记录
- **超时控制**: 支持配置超时时间

### 第二阶段：注册提供商

#### 2.1 更新ProviderManager
**文件位置**: `astrbot/core/provider/manager.py`

**修改内容**: 在 `load_provider()` 方法中添加新的case分支
```python
case "your_tts_type":
    from .sources.your_tts_source import (
        ProviderYourTTS as ProviderYourTTS,
    )
```

#### 2.2 验证注册
- 确保 `@register_provider_adapter` 装饰器正确注册
- 检查 `provider_registry` 和 `provider_cls_map` 包含新提供商

### 第三阶段：配置管理

#### 3.1 更新默认配置
**文件位置**: `astrbot/core/config/default.py`

**修改内容**: 在 `provider` 列表中添加新提供商配置
```python
"Your TTS Provider": {
    "id": "your_tts",
    "enable": False,
    "provider": "your_provider_name",
    "type": "your_tts_type",
    "provider_type": "text_to_speech",
    "api_key": "",
    "api_base": "https://api.your-provider.com",
    "voice": "default",
    "timeout": 30,
    # 其他特定参数
}
```

#### 3.2 配置参数设计
- **必需参数**: `api_key`, `api_base`
- **可选参数**: `voice`, `timeout`, `rate`, `volume` 等
- **默认值**: 提供合理的默认配置

### 第四阶段：测试验证

#### 4.1 单元测试
- 测试提供商类的初始化和配置加载
- 测试 `get_audio()` 方法的正确性
- 测试错误处理和异常情况

#### 4.2 集成测试
- 在WebUI中配置新提供商
- 测试TTS功能是否正常工作
- 验证QQ平台语音发送功能

#### 4.3 端到端测试
- 发送消息触发LLM回复
- 验证TTS合成过程
- 确认QQ收到语音消息

## 🎯 实施步骤

### 步骤1: 环境准备 ✅ **已完成**
1. ✅ 确定新TTS提供商的API接口 - 自定义HTTP API
2. ✅ 获取API密钥和文档 - 支持Bearer Token认证
3. ✅ 了解音频格式要求 - 输出WAV格式

### 步骤2: 代码实现 ✅ **已完成**
1. ✅ 创建 `custom_tts_source.py` 文件
2. ✅ 实现 `ProviderCustomTTS` 类
3. ✅ 添加注册装饰器 `@register_provider_adapter`
4. ✅ 添加详细的中文注释和文档
5. ✅ 为所有修改的文件添加注释说明

### 步骤3: 系统集成 ✅ **已完成**
1. ✅ 更新 `manager.py` 注册新提供商 - 添加 `custom_tts_api` case + 注释
2. ✅ 更新 `default.py` 添加默认配置 - 完整的配置模板 + 详细注释
3. ⏳ 重启AstrBot服务 - 待用户操作

### 步骤4: 配置测试 ⏳ **待进行**
1. ⏳ 在WebUI中启用新提供商
2. ⏳ 配置API密钥和参数
3. ⏳ 测试TTS功能

### 步骤5: 功能验证 ⏳ **待进行**
1. ⏳ 发送测试消息
2. ⏳ 验证语音合成
3. ⏳ 确认QQ语音发送

## 🔍 关键检查点

### 代码质量 ✅ **已完成**
- ✅ 继承 `TTSProvider` 基类
- ✅ 实现 `get_audio()` 方法
- ✅ 正确的装饰器注册
- ✅ 完善的错误处理
- ✅ 详细的中文注释和文档
- ✅ 所有修改文件都添加了注释说明

### 配置管理 ✅ **已完成**
- ✅ 默认配置正确
- ✅ 参数验证完整
- ⏳ WebUI显示正常 - 待重启后验证

### 系统集成 ✅ **已完成**
- ✅ ProviderManager正确加载
- ⏳ 管道处理正常 - 待重启后验证
- ⏳ QQ平台适配工作 - 待重启后验证

### 功能测试 ⏳ **待进行**
- ⏳ TTS合成成功
- ⏳ 音频格式正确
- ⏳ QQ发送正常

## 📝 注意事项

1. **音频格式**: 确保返回WAV格式，QQ平台会自动转换为SILK
2. **文件管理**: 使用临时目录，避免文件积累
3. **错误处理**: 提供详细的错误信息和日志
4. **配置验证**: 在初始化时验证必要参数
5. **性能考虑**: 合理设置超时时间和重试机制

## 🚀 预期结果

完成修改后，用户将能够：
1. ✅ 在WebUI中看到新的TTS提供商选项 - "Custom TTS(API)"
2. ✅ 配置新提供商的API参数 - 支持API地址、密钥、语音参数等
3. ✅ 通过 `/tts` 命令控制语音合成 - 会话级控制
4. ⏳ 在QQ中正常接收语音消息 - 待测试验证

## 📊 当前进度总结

### ✅ 已完成 (80%)
- **代码实现**: 完整的自定义TTS提供商类
- **系统集成**: 注册到ProviderManager和配置系统
- **文档完善**: 详细的中文注释和使用说明
- **配置模板**: 完整的默认配置参数
- **注释完善**: 所有修改文件都添加了详细注释

### ⏳ 待完成 (20%)
- **服务重启**: 重启AstrBot以加载新提供商
- **功能测试**: 在WebUI中配置和测试TTS功能
- **端到端验证**: 验证从文本到QQ语音的完整流程

### 🎯 下一步行动
1. **重启AstrBot服务**以加载新的TTS提供商
2. **在WebUI中配置**Custom TTS提供商
3. **部署TTS服务**到指定地址 (默认: http://127.0.0.1:8000)
4. **测试语音合成功能**

## 📚 参考资源

- 现有TTS提供商实现: `astrbot/core/provider/sources/`
- 提供商基类: `astrbot/core/provider/provider.py`
- 注册机制: `astrbot/core/provider/register.py`
- 配置管理: `astrbot/core/config/default.py`
- 管道集成: `astrbot/core/pipeline/result_decorate/stage.py`
