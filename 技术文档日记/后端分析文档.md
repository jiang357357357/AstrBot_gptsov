# 后端分析文档

## AstrBot 后端架构

### 核心模块
```
astrbot/core/
├── core_lifecycle.py       # 系统生命周期管理
├── config/                 # 配置管理
├── provider/               # 服务提供商 (LLM/TTS/STT)
├── platform/               # 平台适配器 (QQ/Telegram等)
├── star/                   # 插件系统
├── pipeline/               # 消息处理管道
├── db/                     # 数据库 (SQLite + FAISS)
└── agent/                  # Agent 系统
```

### 核心组件

#### 1. 生命周期管理 (core_lifecycle.py)
- 系统启动/停止/重启
- 组件初始化和热重载
- 事件总线管理

#### 2. 配置管理 (config/)
- 多配置文件支持
- 配置热重载
- 配置版本管理

#### 3. 服务提供商 (provider/)
- **LLM**: OpenAI, Anthropic, Gemini, Ollama, 智谱AI
- **TTS**: GSV TTS, Edge TTS, OpenAI TTS, FishAudio
- **STT**: Whisper, SenseVoice
- **其他**: 嵌入、重排序服务

#### 4. 平台适配器 (platform/)
- **即时通讯**: QQ, Telegram, Discord, Slack, KOOK
- **企业通讯**: 企业微信, 钉钉, 飞书
- **社交媒体**: 微信公众号, Misskey, Satori
- **其他**: WebChat, VoceChat

#### 5. 插件系统 (star/)
- 插件热重载
- 插件安装/卸载
- 权限控制
- **内置插件**: python_interpreter, web_searcher, reminder

#### 6. 消息管道 (pipeline/)
- 预处理 → 安全检查 → 处理 → 响应
- 洋葱模型处理
- 异步处理

#### 7. 数据库 (db/)
- **SQLite**: 对话、统计、用户偏好、人设
- **FAISS**: 向量检索、知识库

#### 8. Agent 系统 (agent/)
- 多轮对话
- 工具调用
- MCP 协议支持

### 技术特点
- **异步编程**: 基于 asyncio 的高并发处理
- **模块化设计**: 松耦合的组件架构
- **事件驱动**: 基于事件总线的消息处理
- **配置驱动**: 运行时配置修改
- **插件化**: 动态加载和热重载

### 数据流
```
消息 → 平台适配器 → 事件总线 → 管道调度器 → 处理 → 响应
```

### 核心特性
- 支持 10+ 消息平台
- 支持 20+ 服务提供商
- 插件热重载
- Agent 协作
- 向量检索

### 语音合成位置
- **TTS 提供商**: `astrbot/core/provider/sources/gsv_selfhosted_source.py`
  - `get_audio()` 方法：调用 TTS 服务生成音频文件
- **消息管道**: `astrbot/core/pipeline/result_decorate/stage.py`
  - 第183-218行：TTS 集成逻辑，将文本转换为语音
- **TTS 控制**: `packages/astrbot/main.py`
  - `/tts` 命令：用户控制语音合成开关

### QQ 语音发送位置
- **QQ 官方平台**: `astrbot/core/platform/sources/qqofficial/qqofficial_message_event.py`
  - 第289-310行：音频格式转换 (WAV → SILK)
  - 第126-131行：群组语音发送
  - 第142-147行：C2C 语音发送
  - 第197-240行：`upload_group_and_c2c_record()` 上传语音文件

### QQ 语音合成判断流程
```
用户发送消息
    ↓
消息处理管道
    ↓
LLM生成回复
    ↓
ResultDecorateStage
    ↓
检查三个条件：
1. 全局TTS启用？ ✓/✗
2. 是LLM结果？ ✓/✗  
3. 会话TTS启用？ ✓/✗
    ↓
全部满足 → 调用TTS合成语音
    ↓
创建Record组件
    ↓
发送语音消息
```

### 语音合成判断条件
- **全局配置**: `provider_tts_settings.enable` (WebUI控制)
- **会话控制**: `/tts` 命令切换当前会话状态
- **结果类型**: 只有LLM生成的文本才会合成语音
- **双重检查**: 全局 + 会话级双重验证
